// ...existing code...

  // --- Main Guessing Logic ---
  const handleSubmitAnswer = async () => {
    if (status !== "playing" || !studentAnswer.trim() || isCheckingAnswer)
      return;

    setIsCheckingAnswer(true);
    setDialogue("Sinusuri ko ang iyong sagot...");

    try {
      const result = await emojiSentenceAPI.checkAnswer(
        studentAnswer,
        currentQuestion.keywords
      );

      if (result.error) {
        throw new Error(result.error);
      }

      const pointsEarned = result.points || (result.valid ? 20 : 0);
      const basePoints = pointsEarned;
      const streakBonus = streak >= 3 ? Math.floor(basePoints * 0.25) : 0;
      const totalPoints = basePoints + streakBonus;

      const newResult: GameResult = {
        questionData: currentQuestion,
        isCorrect: result.valid,
        userAnswer: studentAnswer.trim(),
        pointsEarned: totalPoints,
      };

      const updatedResults = [...results, newResult];

      if (result.valid) {
        // Correct
        setStatus("completed");
        const newScore = score + totalPoints;
        setScore(newScore);
        setStreak((prev) => prev + 1);
        setTimeLeft((prev) => Math.min(prev + BONUS_TIME, TIME_LIMIT));

        setResults(updatedResults);

        if (pointsEarned === 20) {
          setLilaState(Math.random() > 0.5 ? "happy" : "thumbsup");
          const bonusText = streakBonus > 0 ? ` + ${streakBonus} streak bonus` : "";
          setDialogue(
            `Perfect! Lahat ay tama! \n\n Nakuha mo: +${totalPoints} points${
              bonusText ? ` (${pointsEarned} base${bonusText})` : ""
            }\n⏱️ Bonus time: +${BONUS_TIME} seconds!`
          );
        } else if (pointsEarned >= 15) {
          setLilaState("happy");
          const bonusText = streakBonus > 0 ? ` + ${streakBonus} streak bonus` : "";
          setDialogue(
            `Magaling! May konting English words pero ok na. \n\n Nakuha mo: +${totalPoints} points${
              bonusText ? ` (${pointsEarned} base${bonusText})` : ""
            }\n⏱️ Bonus time: +${BONUS_TIME} seconds!`
          );
        } else if (pointsEarned >= 10) {
          setLilaState("normal");
          const bonusText = streakBonus > 0 ? ` + ${streakBonus} streak bonus` : "";
          setDialogue(
            `Pwede na, pero maraming English words. \n\n Nakuha mo: +${totalPoints} points${
              bonusText ? ` (${pointsEarned} base${bonusText})` : ""
            }\n⏱️ Bonus time: +${BONUS_TIME} seconds!`
          );
        }

        setIsCheckingAnswer(false);
        setShowNextButton(true);
      } else {
        // Incorrect
        const newMistakes = mistakes + 1;
        setMistakes(newMistakes);
        setLilaState("sad");
        setStreak(0);

        let newScore = score;
        if (pointsEarned > 0) {
          newScore = score + pointsEarned;
          setScore(newScore);
          setDialogue(
            `Ay, may mali pero may points ka pa rin.\n\n Nakuha mo: +${pointsEarned} points\n\n${
              result.explanation || "Subukan mo ulit next time!"
            }`
          );
        } else {
          setDialogue(
            `Ay, may mali. Hindi tama ang sagot. \n\n Nakuha mo: 0 points\n\n${
              result.explanation || "Walang natanggap na points."
            }`
          );
        }

        setResults(updatedResults);
        setIsCheckingAnswer(false);
        setShowNextButton(true);

        if (newMistakes >= MAX_MISTAKES) {
          setStatus("failed");
          setLilaState("crying");
          setDialogue("Maraming mali. Subukan muli!");
        }
      }
    } catch (err: any) {
      console.error("Error checking answer:", err);

      let errorMessage = "Nagkaroon ng error. Subukan muli.";

      if (err.response?.status === 429) {
        errorMessage = "Masyadong maraming request. Sandali lang... ";
        setLilaState("worried");
      } else if (err.response?.status === 408) {
        errorMessage = "Timeout. Subukan ulit!";
        setLilaState("worried");
      } else if (err.message) {
        errorMessage = err.message;
        setLilaState("sad");
      }

      setDialogue(errorMessage);

      if (err.response?.status === 429) {
        setTimeout(() => {
          setDialogue("Subukan mo ulit ngayon!");
          setLilaState("normal");
          setIsCheckingAnswer(false);
        }, 3000);
      } else {
        setIsCheckingAnswer(false);
      }
    }
  };

  const handleSkip = () => {
    if (status !== "playing" || isCheckingAnswer) return;

    setStatus("skipped");
    setLilaState("sad");
    setDialogue("Okay lang 'yan. Eto ang susunod. \n\n Nakuha mo: 0 points (skipped)");
    setStreak(0);

    const skippedResult: GameResult = {
      questionData: currentQuestion,
      isCorrect: false,
      userAnswer: "(skipped)",
      pointsEarned: 0,
    };

    const updatedResults = [...results, skippedResult];
    setResults(updatedResults);
    setShowNextButton(true);
  };

// ...existing code...

              {/* Dialogue */}
              <motion.div
                key={dialogue}
                initial={{ opacity: 0, y: 15 }}
                animate={{ opacity: 1, y: 0 }}
                className="relative bg-purple-50 border border-purple-200 rounded-xl shadow-md py-3 flex items-center justify-center"
              >
                <p className="text-base text-slate-800 text-center px-4 whitespace-pre-line">
                  {dialogue}
                </p>
                {/* Speech bubble pointer */}
                <div className="absolute -left-3 top-1/2 -translate-y-1/2 w-0 h-0 border-t-[12px] border-t-transparent border-b-[12px] border-b-transparent border-r-[12px] border-r-purple-200"></div>
                <div className="absolute -left-2.5 top-1/2 -translate-y-1/2 w-0 h-0 border-t-[10px] border-t-transparent border-b-[10px] border-b-transparent border-r-[10px] border-r-purple-50"></div>
              </motion.div>

// ...existing code...