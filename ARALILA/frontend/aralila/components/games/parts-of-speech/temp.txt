import { cn } from "@/lib/utils";
import { Card } from "./card";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Button } from "@/components/ui/button";

// ...existing type definitions...

export const Challenge = ({
  challenge,
  onSelect,
  status,
  selectedOption,
  disabled,
  textAnswer,
  onTextChange,
  arrangedWords,
  onArrange,
  selectedPunctuation,
  onPunctuate,
  taggedWords,
  onTag,
}: ChallengeProps) => {
  // ...existing SPELL code...

  // ...existing ARRANGE code...

  // ðŸ‘‡ PUNCTUATE type - Click-based like the Punctuation Task game
  if (challenge.type === "PUNCTUATE") {
    const sentence = challenge.question;

    // Get all unique punctuation marks
    const availableMarks: string[] = Array.from(
      new Set(challenge.punctuationMarks?.map((pm: any) => pm.mark) || [])
    );

    // Get correct positions where punctuation should be placed
    const correctPositions = new Set(
      challenge.punctuationMarks?.flatMap((pm: any) => pm.positions) || []
    );

    // Split sentence into characters
    const characters: string[] = sentence.split("");

    // Find the next empty gap
    const nextGapPosition = Array.from(correctPositions).find(
      (pos) => !selectedPunctuation?.some((p) => p.position === pos)
    );

    const handlePunctuationClick = (mark: string) => {
      if (nextGapPosition === undefined || disabled) return;

      // Add punctuation to the next gap
      const newPunctuation = [
        ...(selectedPunctuation || []),
        { mark, position: nextGapPosition },
      ];

      onPunctuate?.(newPunctuation);
    };

    const removePunctuation = (position: number) => {
      const newPunctuation =
        selectedPunctuation?.filter((p) => p.position !== position) || [];
      onPunctuate?.(newPunctuation);
    };

    return (
      <div className="flex flex-col gap-6">
        {/* Sentence with gaps */}
        <div className="text-xl flex flex-wrap items-center p-6 bg-neutral-50 rounded-lg border-2 border-dashed min-h-[100px]">
          {characters.map((char: string, index: number) => (
            <span key={index} className="inline-flex items-center">
              <span className="px-0.5">{char}</span>

              {/* Show gap at positions where punctuation belongs */}
              {correctPositions.has(index) && (
                <span
                  className={cn(
                    "inline-flex items-center justify-center min-w-[40px] h-[40px] mx-1",
                    "border-2 border-dashed rounded-lg",
                    selectedPunctuation?.some((p) => p.position === index)
                      ? "border-green-500 bg-green-50"
                      : nextGapPosition === index
                      ? "border-purple-500 bg-purple-50 animate-pulse"
                      : "border-neutral-300 bg-white",
                    "transition-all"
                  )}
                >
                  {selectedPunctuation?.find((p) => p.position === index) ? (
                    <button
                      onClick={() => removePunctuation(index)}
                      className="text-2xl font-bold text-green-600 hover:text-red-500 px-2 transition-colors"
                      disabled={disabled}
                      title="Click to remove"
                    >
                      {
                        selectedPunctuation.find((p) => p.position === index)
                          ?.mark
                      }
                    </button>
                  ) : nextGapPosition === index ? (
                    <span className="text-lg text-purple-400 animate-pulse">
                      ?
                    </span>
                  ) : (
                    <span className="text-sm text-neutral-300">_</span>
                  )}
                </span>
              )}
            </span>
          ))}
        </div>

        {/* Punctuation mark buttons */}
        <div className="space-y-3">
          <p className="text-sm text-neutral-600 font-medium text-center">
            Click a punctuation mark to fill the highlighted gap:
          </p>
          <div className="flex items-center justify-center gap-4">
            {availableMarks.map((mark: string, index: number) => (
              <button
                key={index}
                onClick={() => handlePunctuationClick(mark)}
                disabled={disabled || nextGapPosition === undefined}
                className={cn(
                  "flex items-center justify-center",
                  "w-16 h-16 text-3xl font-bold rounded-xl border-4",
                  "transition-all transform",
                  nextGapPosition !== undefined && !disabled
                    ? "bg-white border-purple-500 text-purple-600 hover:bg-purple-50 hover:scale-110 active:scale-95 shadow-lg cursor-pointer"
                    : "bg-neutral-100 border-neutral-300 text-neutral-400 cursor-not-allowed",
                  disabled && "opacity-50"
                )}
              >
                {mark}
              </button>
            ))}
          </div>
        </div>

        {/* Helper text */}
        {selectedPunctuation && selectedPunctuation.length > 0 && (
          <p className="text-sm text-neutral-500 text-center">
            ðŸ’¡ Click on placed punctuation to remove it
          </p>
        )}
      </div>
    );
  }

  // ...existing TAG_POS code...

  // ...existing COMPOSE code...

  // ...existing SELECT/ASSIST code...
};